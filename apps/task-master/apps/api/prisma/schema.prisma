generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  username     String   @unique // immutable
  displayName  String   @default("")
  email        String?
  role         String   @default("MEMBER") // 'ADMIN' | 'MEMBER'
  active       Boolean  @default(true)
  projectIds   String[] @db.ObjectId @default([])
  preferredAgentId String? @db.ObjectId
  monthlyTokenLimit Int?
  monthlyCostLimit  Float?
  color String? @default("#3b82f6")

  passwordHash String
  apiKey       String   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NotificationSubscription {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  projectId String?  @db.ObjectId
  channel   String   @default("slack") // 'slack' | 'email'
  target    String   @default("") // webhook url or email
  mentionsOnly Boolean @default(true)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
}

type ProjectColumn {
  name    String
  order   Int
  enabled Boolean @default(true)
}

model Project {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  code      String  @unique
  name      String
  createdBy String  @default("amdsh")
  active    Boolean @default(true)
  columns   ProjectColumn[]
  description String @default("")
  repoPath    String @default("")
  localPath   String @default("")
  notes       String @default("")
  color       String @default("")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks   Task[]
  routingRules RoutingRule[]
  analysis ProjectAnalysis?
}

model ProjectAnalysis {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId    String   @unique @db.ObjectId
  reportMarkdown String @default("")
  status       String   @default("idle") // idle | queued | running | complete | failed
  jobId        String?
  lastError    String?
  startedAt    DateTime?
  completedAt  DateTime?
  generatedAt  DateTime?
  generatedBy  String   @default("")
  model        String   @default("")
  repoPath     String   @default("")
  repoFileCount Int     @default(0)
  repoChunkCount Int    @default(0)
  repoError    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  files   ProjectAnalysisFile[]

  @@index([projectId])
}

model ProjectAnalysisFile {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  analysisId  String   @db.ObjectId
  filePath    String
  title       String   @default("")
  contentMarkdown String @default("")
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  analysis ProjectAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId])
  @@unique([analysisId, filePath])
}

model Task {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId   String   @db.ObjectId
  columnName  String
  title       String
  description String   @default("")
  order       Int

  // first-class ticket id: PROJECTCODE-ticketNumber (e.g., FM-1)
  ticketNumber Int?

  // Epics: a Task can be an epic, and stories/bugs can link to an epic.
  epicId    String?  @db.ObjectId
  epicColor String   @default("") // only meaningful for type='epic'
  epic      Task?    @relation("EpicStories", fields: [epicId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stories   Task[]   @relation("EpicStories")
  currentAgents Agent[] @relation("AgentCurrentTask")
  documents Document[] @relation("TaskDocuments")

  dueAt     DateTime?
  tags      String   @default("")
  assignee  String   @default("")
  createdBy String   @default("amdsh")
  priority  String   @default("") // 'high' | 'medium' | 'low'
  type      String   @default("") // 'story' | 'bug' | 'epic'
  sessionKey String  @default("")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  comments Comment[]

  @@index([projectId])
  @@index([columnName])
  @@index([epicId])
  @@unique([projectId, ticketNumber])
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId    String   @db.ObjectId
  author    String   @default("ahmed")
  body      String
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([taskId])
}

model Activity {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  at        DateTime @default(now())
  actor     String   @default("system")
  action    String
  detail    String   @default("")
  projectId String?  @db.ObjectId
  taskId    String?  @db.ObjectId

  // optional structured fields for move history
  fromColumnName String?
  toColumnName   String?
}

model TalonRetry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId    String   @db.ObjectId
  projectId String?  @db.ObjectId
  agentId   String
  request   Json
  attempts  Int      @default(0)
  status    String   @default("pending") // pending | processing | done | failed
  lastError String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([taskId])
}

model RoutingRule {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId String   @db.ObjectId
  agentId   String   @db.ObjectId
  type      String   @default("") // 'story' | 'bug' | 'epic' | ''
  priority  String   @default("") // 'high' | 'medium' | 'low' | ''
  assignee  String   @default("")
  order     Int      @default(0)
  enabled   Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([agentId])
}

model UsageEntry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId String?  @db.ObjectId
  taskId    String?  @db.ObjectId
  agentId   String?  @db.ObjectId
  userId    String?  @db.ObjectId
  model     String   @default("")
  inputTokens  Int   @default(0)
  outputTokens Int   @default(0)
  totalTokens  Int   @default(0)
  costUsd      Float?
  createdAt DateTime @default(now())

  @@index([projectId])
  @@index([agentId])
  @@index([userId])
}

model Agent {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  role          String   @default("")
  model         String   @default("")
  defaultModel  String?
  fallbackModel String?
  isMain        Boolean  @default(false)
  talonWorkspaceId String? 
  talonAgentId   String? 
  soul          String   @default("")
  bootstrap     String   @default("")
  everyone      String   @default("")
  guardrails    String   @default("")
  status        String   @default("idle") // idle | active | blocked
  sessionKey    String   @default("")
  currentTaskId String?  @db.ObjectId
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  currentTask Task? @relation("AgentCurrentTask", fields: [currentTaskId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  messages   AgentMessage[] @relation("AgentMessages")
  modelId       String?   @db.ObjectId
  llmModel      LlmModel? @relation("AgentLlmModel", fields: [modelId], references: [id])

  @@index([currentTaskId])
}

model Document {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  content   String   @default("")
  type      String   @default("deliverable")
  taskId    String?  @db.ObjectId
  createdBy String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task? @relation("TaskDocuments", fields: [taskId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([taskId])
}

model AgentMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  agentId   String   @db.ObjectId
  author    String   @default("")
  body      String
  createdAt DateTime @default(now())

  agent Agent @relation("AgentMessages", fields: [agentId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([agentId])
}

model LlmProvider {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  name            String    @unique
  providerType    String    // google, openai, anthropic, azure, ollama
  baseUrl         String?
  encryptedApiKey Bytes?
  apiKeyNonce     Bytes?
  apiKeyTag       Bytes?
  orgId           String?   // For OpenAI
  deploymentId    String?   // For Azure
  color           String    @default("#6366f1")
  status          String    @default("unknown") // unknown, valid, invalid
  lastValidatedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  models          LlmModel[]
}

model LlmModel {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  providerId      String      @db.ObjectId
  provider        LlmProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerModelId String      // e.g., "gemini-2.0-flash"
  displayName     String
  modality        String[]    @default([])
  contextWindow   Int?
  inputCostPer1k  Float?
  outputCostPer1k Float?
  enabled         Boolean     @default(true)
  meta            Json        @default("{}")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  agents          Agent[]     @relation("AgentLlmModel")

  @@unique([providerId, providerModelId])
}

model SeedRecord {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  runAt     DateTime @default(now())
}
